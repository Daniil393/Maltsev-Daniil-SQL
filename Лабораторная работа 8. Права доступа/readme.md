# ИКНТ, Мальцев Даниил – группа ИТ18. Отчёт по лабораторной работе №8: Права доступа в PostgreSQL

## *1. Цель работы*

Целью работы является проектирование базы данных с разграничением прав доступа для различных категорий пользователей, а также практическая настройка прав на уровне СУБД PostgreSQL, включая:
* права на таблицы;
* права на отдельные столбцы;
* разграничение доступа на уровне строк (Row-Level Security, RLS);
* использование ролей (групп пользователей).

## *2. Описание предметной области*

В рамках работы реализована упрощённая CMS-система (Content Management System), включающая:
* пользователей системы;
* статьи;
* комментарии к статьям.

Структура базы данных реализована в схеме cms.

## *3. Структура базы данных*

*Таблицы*

cms.users
Хранит пользователей системы.
* id — идентификатор пользователя;
* username — имя пользователя;
* email — электронная почта;
* role — логическая роль (admin, editor, viewer);
* created_at — дата создания.

cms.articles
Хранит статьи.
* id — идентификатор статьи;
* author_id — автор статьи;
* title — заголовок;
* content — текст статьи;
* is_published — признак публикации;
* created_at — дата создания.

cms.comments
Хранит комментарии к статьям.
* id — идентификатор комментария;
* article_id — статья;
* user_id — автор комментария;
* text — текст комментария;
* created_at — дата создания.

## *4. Категории пользователей и ролевая модель*

В системе реализована ролевая модель доступа. Каждая категория пользователей представлена отдельной ролью.

*4.1 Роли*
* admin — администратор системы
* editor — редактор контента
* viewer — обычный пользователь (читатель)
* reporting_user — аналитик (только отчёты)
* app_user — базовая роль для доступа к схеме

Роли используются как группы, к которым привязываются реальные пользователи СУБД.

*4.2 Пользователи СУБД*
| Пользователь | Роль           |
| ------------ | -------------- |
| james        | admin          |
| carol        | editor         |
| alice        | viewer         |
| report       | reporting_user |

## *5. Разграничение прав доступа*

*5.1 Права на уровне схемы*

Все прикладные роли имеют доступ к схеме cms:

```SQL
grant usage on schema cms to app_user;
```

*5.2 Права на уровне таблиц*

### ADMIN
Полный доступ ко всем таблицам и последовательностям:
* select, insert, update, delete
* all privileges на sequence

Администратор фактически обладает возможностями владельца данных.

### EDITOR
* Чтение таблицы users;
* Чтение, добавление и изменение статей;
* Добавление комментариев;
* Ограничения по строкам реализованы через RLS.

### VIEWER
* Только чтение всех таблиц;
* Ограничения по строкам (только опубликованные статьи).

### REPORTING_USER
Доступ только к отдельным столбцам:
* articles(id, is_published, created_at)
* comments(id, article_id, created_at)
Полный запрет доступа к таблице users.

Таким образом демонстрируется разграничение прав на уровне столбцов.

## *6. Row-Level Security (RLS)*

*6.1 Статьи (cms.articles)*

### Таблица cms.articles с учётом Row-Level Security (RLS)

|Role|SELECT|INSERT|UPDATE|DELETE|RLS ограничения|
|:---------|:--------:|:---------:|:---------:|:--------:|:--------:|
|admin|✔️|✔️|✔️|✔️|RLS не применим|
|editor|✔️|✔️|✔️ (только свои статьи)|✘|update/check author_id = current_user|
|viewer|✔️ (только опубликованные)|✘|✘|✘|is_published = true|
|reporting_user|✔️ (только опубликованные + ограниченные столбцы)|✘|✘|✘|is_published = true|

viewer — может читать только опубликованные статьи;
reporting_user — может читать только опубликованные статьи и только разрешённые столбцы;
editor — видит все статьи, может изменять только свои статьи.

*6.2 Комментарии (cms.comments)*

### Таблица cms.comments с учётом RLS

|Role|SELECT|INSERT|UPDATE|DELETE|RLS ограничения|
|:---------|:--------:|:---------:|:---------:|:--------:|:--------:|
|admin|✔️|✔️|✔️|✔️|RLS не применим|
|editor|✔️|✔️ (только user_id = current_user)|✘|✘|писать только от своего имени|
|viewer|✔️|✘|✘|✘|видеть все строки|
|reporting_user|✔️ (ограниченные столбцы)|✘|✘|✘|видеть все строки|

viewer — читает все комментарии;
reporting_user — читает комментарии только в аналитических целях;
editor — может добавлять комментарии только от своего имени.

*6.3 Пользователи (cms.users)*

### Таблица cms.users, RLS - отсутствует

|Role|SELECT|INSERT|UPDATE|DELETE|
|:---------|:--------:|:---------:|:---------:|:--------:|
|admin|✔️|✔️|✔️|✔️|
|editor|✔️|✘|✘|✘|
|viewer|✔️|✘|✘|✘|
|reporting_user|✘|✘|✘|✘|

## *7. Default Privileges*

Настроены права по умолчанию для будущих таблиц в схеме cms:
* viewer — select
* editor — select, insert, update
* admin — полный доступ

Это позволяет автоматически поддерживать модель безопасности при расширении схемы.

## *8. Демонстрация различий в возможностях пользователей*

| Действие                       | admin | editor | viewer | reporting_user |
| ------------------------------ | ----- | ------ | ------ | -------------- |
| Читать пользователей           | ✔     | ✔      | ✔      | ✘              |
| Создавать статьи               | ✔     | ✔      | ✘      | ✘              |
| Редактировать чужие статьи     | ✔     | ✘      | ✘      | ✘              |
| Читать неопубликованные статьи | ✔     | ✔      | ✘      | ✘              |
| Читать отдельные столбцы       | ✔     | ✔      | ✔      | ✔              |
| Комментарии от чужого имени    | ✔     | ✘      | ✘      | ✘              |

Таким образом:
* администратор обладает полным доступом;
* редактор ограничен своими данными;
* пользователь имеет доступ только к опубликованному контенту;
* аналитик видит данные в обезличенном и ограниченном виде.
