# ИКНТ, Мальцев Даниил – группа ИТ18. Отчёт по лабораторной работе №6: Модификация представлений и реализация INSTEAD OF триггеров

## *1. Цель работы*

Цель работы - спроектировать базу данных, содержащую отношение типа «многие-ко-многим», создать представление, скрывающее идентификаторы таблиц, и реализовать триггеры INSTEAD OF для обеспечения корректной вставки, обновления и удаления данных через это представление.

Особое внимание уделяется:
+ корректному возврату значений в триггерных функциях при работе с представлениями;
+ недопущению повторных поисков одних и тех же данных;
+ тестированию корректности реализации всех операций.

<p>&nbsp;</p>

## *2. Структура базы данных*

Модель включает три таблицы:
+ Readers - читатели
Содержит персональные данные: фамилия, имя, отчество и адрес.

+ Books - книги
Содержит автора, название, год и залог за книгу.

+ Subscription - связь M:N
Определяет факт получения книги читателем.
Помимо внешних ключей содержит атрибуты: дата выдачи и дата возврата.

Таблицы реализуют классическую структуру связи многие ко многим (читатель - книга) через таблицу-связку.

<p>&nbsp;</p>

## *3. Представление*
Создано представление subscription_view, которое объединяет данные читателей, книг и связки, но не включает первичные ключи (reader_id, book_id, issue_id).

Задача: предоставить пользователю логически цельное отображение данных без технических идентификаторов.

<p>&nbsp;</p>

## *4. Реализация триггеров*
Поскольку представление не хранит данные, операции INSERT, UPDATE, DELETE должны быть перенаправлены в базовые таблицы. Для этого используются триггеры INSTEAD OF.

Все триггерные функции корректно возвращают NULL, что соответствует требованиям PostgreSQL для представлений без собственных строк хранения.

### *4.1. Триггер INSERT*

Функция:

1.Ищет существующего читателя по комбинации текстовых полей.
Поиск выполняется один раз, избегая дублирования выражений.

2.Если читатель не найден - создаёт запись и возвращает идентификатор.

3.Аналогично обрабатывает книгу.

4.Создаёт новую запись в таблице-связке.

5.Возвращает NULL.

Функция корректно реализует следующее поведение:

*пользователь может вставлять новые строки в представление, не заботясь о существовании связанных данных - система обеспечит целостность сама.*

### *4.2. Триггер UPDATE*

Основные действия:

1.Находит идентификаторы читателя и книги по старым значениям.

2.Обновляет запись в таблице subscription.

3.Значения читателя и книги через представление не меняются. 

Также используется единичный поиск идентификаторов, что удовлетворяет требованию не выполнять одну и ту же операцию несколько раз.

### *4.3. Триггер DELETE*

Удаляет строку из subscription по найденным идентификаторам и дате выдачи. Аналогично, поиск выполнен один раз.

<p>&nbsp;</p>

## *5. Тестирование*

### *5.1. INSERT*

Вставка новой записи через представление:

```java
insert into subscription_view (last_name, first_name, patronymic, address, author, title, pub_year, deposit, issue_date, return_date)
values ('Иванов', 'Тимофей', 'Кириллович', 'Москва', 'Лев Толстой', 'Война и мир', 1869, 500,
 '2025-12-22', null);
```

Результат:

+ в таблицу readers добавлен новый читатель;
+ в books добавлена книга;
+ в subscription добавлена запись, содержащая полученные внешние ключи.

*Таблица books* :
<img width="869" height="58" alt="image" src="https://github.com/user-attachments/assets/9285a191-dab0-4bae-b1b8-bd6583dcaa82" />

*Таблица readers* :
<img width="988" height="59" alt="image" src="https://github.com/user-attachments/assets/5699e99b-588a-4c7e-89c9-dd34c63503f7" />

*Таблица subscription* :
<img width="987" height="60" alt="image" src="https://github.com/user-attachments/assets/a4be4c2c-7e66-404b-b5a7-87c3cd8f29a3" />

Вывод подтверждает корректность всех трёх вставок.

### *5.2. UPDATE*

```java
update subscription_view
set return_date = '2025-12-25'
where last_name = 'Иванов' and title = 'Война и мир';
```

В таблице subscription обновлено только поле return_date.
Ключевые поля не затронуты.

Проверка:
```java
select * from subscription;
```

Результат корректен.

### *5.3. DELETE*
```java
delete from subscription_view
where last_name = 'Иванов' and title = 'Война и мир';
```

Из таблицы-связки удалена соответствующая запись.

Связанные читатель и книга корректно не удаляются, что соответствует нормальной логике M:N связи.
